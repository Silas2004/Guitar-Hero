name: Java CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Create output directories
      run: |
        mkdir -p out/production
        mkdir -p out/jar
    
    - name: Compile Java files
      run: |
        find . -name "*.java" > sources.txt
        javac -d out/production @sources.txt
    
    - name: Copy resources (if any)
      run: |
        if [ -d "resources" ]; then
          cp -r resources out/production/
        fi
    
    - name: Create JAR file
      run: |
        cd out/production
        jar cvfe ../jar/guitar-hero.jar Main .
        cd ../..
    
    - name: Run tests (if test classes exist)
      continue-on-error: true
      run: |
        if ls out/production/**/*Test.class 1> /dev/null 2>&1; then
          echo "Tests found, running..."
          java -cp out/production org.junit.runner.JUnitCore $(find out/production -name "*Test.class" | sed 's/out\/production\///;s/\.class//;s/\//./g')
        else
          echo "No tests found"
        fi
    
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: guitar-hero-jar
        path: out/jar/guitar-hero.jar
        retention-days: 30
    
    - name: Build summary
      run: |
        echo "âœ… Build successful!"
        echo "ðŸ“¦ JAR created: guitar-hero.jar"
        ls -lh out/jar/
